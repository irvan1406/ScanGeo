<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoTagger Auto Sender + OCR</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- ExifReader Library (Metadata) -->
    <script src="https://cdn.jsdelivr.net/npm/exifreader@4.20.0/dist/exif-reader.min.js"></script>

    <!-- Tesseract.js (OCR / Text Recognition) -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>

    <!-- Font & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: white; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .progress-bar { transition: width 0.3s ease; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const TARGET_PHONE = "6287745756269";

        const App = () => {
            const [status, setStatus] = useState("IDLE"); // IDLE, PROCESSING, OCR_SCANNING, SUCCESS, ERROR
            const [logs, setLogs] = useState([]);
            const [gpsData, setGpsData] = useState(null);
            const [errorMessage, setErrorMessage] = useState("");
            const [ocrProgress, setOcrProgress] = useState(0);
            const fileInputRef = useRef(null);

            const addLog = (msg) => {
                setLogs(prev => [...prev, msg]);
            };

            const resetApp = () => {
                setStatus("IDLE");
                setLogs([]);
                setGpsData(null);
                setErrorMessage("");
                setOcrProgress(0);
                if(fileInputRef.current) fileInputRef.current.value = "";
            };

            // --- HELPER: Parse Koordinat dari Teks OCR ---
            const findCoordinatesInText = (text) => {
                // Pola Regex untuk menangkap format umum: -7.12345, 110.12345 (Desimal)
                // Menangani variasi spasi, koma, atau baris baru
                // Grup 1: Latitude, Grup 2: Longitude
                const decimalPattern = /(-?\d{1,2}[.,]\d{4,})[\s,]+(-?\d{1,3}[.,]\d{4,})/;
                
                // Pola untuk format Lat: -7.123 Long: 110.123
                const labeledPattern = /(?:Lat|Latitude)[\s:]*(-?\d{1,2}[.,]\d{3,}).*(?:Long|Lon|Longitude)[\s:]*(-?\d{1,3}[.,]\d{3,})/i;

                let match = text.match(decimalPattern);
                if (!match) {
                    match = text.match(labeledPattern);
                }

                if (match) {
                    // Ganti koma dengan titik jika formatnya Indonesia (misal -7,123)
                    let lat = parseFloat(match[1].replace(',', '.'));
                    let long = parseFloat(match[2].replace(',', '.'));

                    // Validasi range latitude longitude
                    if (lat >= -90 && lat <= 90 && long >= -180 && long <= 180) {
                        return { lat, long };
                    }
                }
                return null;
            };

            const runOCR = async (file) => {
                setStatus("OCR_SCANNING");
                addLog("ðŸ‘ï¸ Mencoba scan tulisan di foto (OCR)...");
                addLog("â³ Mohon tunggu, proses AI sedang berjalan...");

                try {
                    const result = await Tesseract.recognize(
                        file,
                        'eng',
                        {
                            logger: m => {
                                if (m.status === 'recognizing text') {
                                    setOcrProgress(Math.round(m.progress * 100));
                                }
                            }
                        }
                    );

                    const extractedText = result.data.text;
                    addLog("âœ… Teks terbaca. Menganalisis pola koordinat...");
                    console.log("OCR Text:", extractedText); // Debugging

                    const coords = findCoordinatesInText(extractedText);

                    if (coords) {
                        const latFixed = coords.lat.toFixed(6);
                        const longFixed = coords.long.toFixed(6);
                        
                        finishSuccess(latFixed, longFixed, "OCR (Scan Teks)");
                    } else {
                        // Coba bersihkan teks dan cari lagi (kadang OCR baca 'S' sebagai '5' atau spasi aneh)
                        // Untuk versi simpel, kita throw error dulu
                        throw new Error("Teks terbaca tapi TIDAK ditemukan koordinat yang valid. Pastikan watermark Lat/Long terlihat jelas.");
                    }

                } catch (err) {
                    console.error(err);
                    setStatus("ERROR");
                    setErrorMessage("Gagal Scan OCR: " + err.message);
                    addLog(`âŒ OCR Error: ${err.message}`);
                }
            };

            const finishSuccess = (lat, long, source) => {
                const resultData = {
                    lat: lat,
                    long: long,
                    mapsLink: `https://www.google.com/maps?q=${lat},${long}`
                };

                setGpsData(resultData);
                addLog(`ðŸ“ Lokasi Ditemukan (${source}): ${lat}, ${long}`);
                setStatus("SUCCESS");
                generateAndSendWhatsApp(resultData);
            }

            const processFile = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                resetApp();
                setStatus("PROCESSING");
                addLog(`ðŸ“‚ Menganalisis file: ${file.name}`);
                
                // STEP 1: Coba baca EXIF dulu (Siapa tau file asli)
                try {
                    addLog("ðŸ” Mencari metadata EXIF...");
                    const tags = await ExifReader.load(file, { expanded: true });
                    
                    let lat = null;
                    let long = null;

                    // Logika pencarian EXIF standard
                    if (tags.gps) {
                        if (tags.gps.Latitude && tags.gps.Longitude) {
                            lat = tags.gps.Latitude;
                            long = tags.gps.Longitude;
                        }
                    } else if (tags.GPSLatitude && tags.GPSLongitude) {
                        // Fallback simple tags
                        // Note: ExifReader v4 expanded=false output format differs, handled in v2 code
                        // Here assuming failures go to catch block or runOCR
                    }

                    if (lat && long) {
                        // Jika EXIF ada, pakai EXIF (lebih akurat)
                        finishSuccess(Number(lat).toFixed(6), Number(long).toFixed(6), "EXIF Metadata");
                        return;
                    } 
                    
                    // Jika tidak ada error tapi tidak ada GPS tags
                    throw new Error("No GPS Tags");

                } catch (err) {
                    addLog("âš ï¸ EXIF tidak ditemukan (File dari WA?).");
                    // STEP 2: Lanjut ke OCR
                    await runOCR(file);
                }
            };

            const generateAndSendWhatsApp = (data) => {
                addLog("ðŸš€ Mempersiapkan pesan WhatsApp...");
                
                const message = `ðŸ“¸ FOTO TERDETEKSI
ðŸ“ Lokasi GPS:
Latitude: ${data.lat}
Longitude: ${data.long}

ðŸ—ºï¸ Google Maps:
${data.mapsLink}`;

                const encodedMessage = encodeURIComponent(message);
                const waUrl = `https://wa.me/${TARGET_PHONE}?text=${encodedMessage}`;

                addLog("ðŸ“¨ Mengalihkan ke WhatsApp...");
                
                setTimeout(() => {
                    window.location.href = waUrl;
                }, 1500);
            };

            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-4">
                    <div className="w-full max-w-md bg-slate-800 rounded-2xl shadow-2xl overflow-hidden border border-slate-700">
                        
                        {/* Header */}
                        <div className="bg-indigo-600 p-6 text-center">
                            <h1 className="text-xl font-bold text-white flex items-center justify-center gap-2">
                                <i data-lucide="scan-line"></i> GeoScanner Pro
                            </h1>
                            <p className="text-indigo-100 text-xs mt-1">Support: EXIF Metadata & OCR Text Scan</p>
                        </div>

                        {/* Content */}
                        <div className="p-6 space-y-6">
                            
                            {/* Input Area */}
                            {status === "IDLE" || status === "ERROR" || status === "SUCCESS" ? (
                                <div className="relative group">
                                    <label className="flex flex-col items-center justify-center w-full h-48 border-2 border-dashed border-slate-500 rounded-xl cursor-pointer bg-slate-700/50 hover:bg-slate-700 transition-all hover:border-indigo-400 group-hover:scale-[1.01]">
                                        <div className="flex flex-col items-center justify-center pt-5 pb-6">
                                            <svg className="w-12 h-12 mb-4 text-slate-400 group-hover:text-indigo-400 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                            <p className="mb-2 text-sm text-slate-300 text-center px-4"><span className="font-semibold text-white">Upload Foto</span><br/>(EXIF atau Foto Ber-Watermark)</p>
                                        </div>
                                        <input 
                                            type="file" 
                                            className="hidden" 
                                            accept="image/*,.heic" 
                                            onChange={processFile} 
                                            ref={fileInputRef}
                                        />
                                    </label>
                                </div>
                            ) : null}

                            {/* Processing Status */}
                            {status === "PROCESSING" && (
                                <div className="flex flex-col items-center py-8 text-center space-y-4">
                                    <div className="loader"></div>
                                    <p className="text-indigo-300 animate-pulse">Cek Metadata EXIF...</p>
                                </div>
                            )}

                            {/* OCR Scanning Status */}
                            {status === "OCR_SCANNING" && (
                                <div className="space-y-4">
                                    <div className="flex flex-col items-center text-center">
                                        <div className="loader border-t-purple-500"></div>
                                        <p className="text-purple-300 mt-4 text-sm font-semibold">Memindai Teks (AI)...</p>
                                        <p className="text-slate-400 text-xs">Mencari angka Latitude/Longitude pada gambar</p>
                                    </div>
                                    <div className="w-full bg-slate-700 rounded-full h-2.5">
                                        <div className="bg-purple-500 h-2.5 rounded-full progress-bar" style={{width: `${ocrProgress}%`}}></div>
                                    </div>
                                    <p className="text-right text-xs text-slate-400">{ocrProgress}%</p>
                                </div>
                            )}

                            {/* Success UI */}
                            {status === "SUCCESS" && gpsData && (
                                <div className="bg-green-500/20 border border-green-500/50 rounded-lg p-4 text-center space-y-3">
                                    <div className="flex justify-center text-green-400">
                                        <svg className="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    </div>
                                    <h3 className="text-lg font-bold text-white">Data Ditemukan!</h3>
                                    <div className="text-xs bg-black/30 p-2 rounded text-left font-mono break-all">
                                        <span className="text-gray-400">Lat:</span> {gpsData.lat}<br/>
                                        <span className="text-gray-400">Long:</span> {gpsData.long}
                                    </div>
                                    <button 
                                        onClick={() => generateAndSendWhatsApp(gpsData)}
                                        className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition-colors text-sm flex items-center justify-center gap-2"
                                    >
                                        <i data-lucide="send"></i> Kirim WA Sekarang
                                    </button>
                                </div>
                            )}

                            {/* Error UI */}
                            {status === "ERROR" && (
                                <div className="bg-red-500/20 border border-red-500/50 rounded-lg p-4">
                                    <div className="flex items-start gap-3">
                                        <svg className="w-6 h-6 text-red-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                                        <div>
                                            <h3 className="font-bold text-red-400 text-sm">Gagal Deteksi</h3>
                                            <p className="text-xs text-red-200 mt-1">{errorMessage}</p>
                                        </div>
                                    </div>
                                    <div className="mt-3 text-xs text-slate-400 bg-slate-800/50 p-2 rounded">
                                        Tips: Pastikan teks koordinat pada foto terlihat jelas, tidak blur, dan kontras dengan background.
                                    </div>
                                </div>
                            )}

                            {/* Console Logs Display */}
                            <div className="bg-black/40 rounded p-3 h-32 overflow-y-auto text-xs font-mono text-slate-400 border border-slate-700">
                                {logs.length === 0 ? <span className="opacity-50">Log sistem siap...</span> : logs.map((log, i) => (
                                    <div key={i} className="mb-1 border-b border-white/5 pb-1 last:border-0">{log}</div>
                                ))}
                            </div>

                        </div>
                        
                        <div className="bg-slate-900 p-3 text-center text-xs text-slate-500 flex justify-between px-6">
                            <span>v3.0 Hybrid (EXIF + OCR)</span>
                            <span className="text-slate-600">Secure Client-Side</span>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        
        // Initialize Icons
        lucide.createIcons();
    </script>
</body>
</html>


