<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoSender Auto-Redirect</title>
    
    <!-- React & Libs -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/exifreader@4.20.0/dist/exif-reader.min.js"></script>
    
    <!-- Tesseract v5 -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0f172a; color: white; }
        .scan-line {
            position: absolute;
            width: 100%;
            height: 4px;
            background: #3b82f6;
            box-shadow: 0 0 10px #3b82f6;
            animation: scanning 2s linear infinite;
        }
        @keyframes scanning { 0% { top: 0; } 100% { top: 100%; } }
        /* Hide scrollbar for logs */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const TARGET_PHONE = "6287745756269";

        // --- IMAGE PROCESSING ENGINE ---
        const preprocessImage = (imageFile) => {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxWidth = 1500;
                    const scale = maxWidth / img.width;
                    canvas.width = img.width > maxWidth ? maxWidth : img.width;
                    canvas.height = img.width > maxWidth ? img.height * scale : img.height;
                    
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    
                    for (let i = 0; i < data.length; i += 4) {
                        const r = data[i];
                        const g = data[i + 1];
                        const b = data[i + 2];
                        let gray = 0.2126 * r + 0.7152 * g + 0.0722 * b;
                        const val = gray > 130 ? 255 : 0; 
                        data[i] = val; data[i + 1] = val; data[i + 2] = val;
                    }
                    ctx.putImageData(imageData, 0, 0);
                    resolve(canvas.toDataURL('image/jpeg'));
                };
                img.onerror = reject;
                img.src = URL.createObjectURL(imageFile);
            });
        };

        const App = () => {
            const [status, setStatus] = useState("IDLE"); // IDLE, PROCESSING, OCR, MANUAL, SUCCESS
            const [logs, setLogs] = useState([]);
            const [gpsData, setGpsData] = useState({ lat: '', long: '' });
            const [previewUrl, setPreviewUrl] = useState(null);
            const [processedPreview, setProcessedPreview] = useState(null);
            
            const fileInputRef = useRef(null);
            const addLog = (msg) => setLogs(p => [`> ${msg}`, ...p]);

            const reset = () => {
                setStatus("IDLE");
                setLogs([]);
                setGpsData({ lat: '', long: '' });
                setPreviewUrl(null);
                setProcessedPreview(null);
                if(fileInputRef.current) fileInputRef.current.value = "";
            };

            const parseText = (text) => {
                const cleanText = text.replace(/[^0-9.,\-\n]/g, ' '); 
                const numbers = cleanText.match(/-?\d{1,3}[.,]\d{4,}/g);

                if (numbers && numbers.length >= 2) {
                    let v1 = parseFloat(numbers[0].replace(',', '.'));
                    let v2 = parseFloat(numbers[1].replace(',', '.'));
                    let lat = v1; let long = v2;
                    if (Math.abs(v1) > 90) { lat = v2; long = v1; } // Swap logic

                    if (lat >= -90 && lat <= 90 && long >= -180 && long <= 180) {
                        return { lat, long };
                    }
                }
                return null;
            };

            const runOCR = async (file) => {
                setStatus("OCR");
                addLog("‚öôÔ∏è Pre-processing: Mempertajam kontras...");
                
                try {
                    const highContrastImage = await preprocessImage(file);
                    setProcessedPreview(highContrastImage); 
                    
                    addLog("üß† AI Membaca teks...");
                    const worker = await Tesseract.createWorker('eng');
                    await worker.setParameters({ tessedit_char_whitelist: '0123456789.-,LatLong: ', });

                    const ret = await worker.recognize(highContrastImage);
                    const coords = parseText(ret.data.text);
                    await worker.terminate();

                    if (coords) {
                        finish(coords.lat, coords.long, "AI Scan");
                    } else {
                        addLog("‚ö†Ô∏è Angka tidak ditemukan. Manual mode.");
                        setStatus("MANUAL");
                    }

                } catch (e) {
                    addLog("‚ùå OCR Error: " + e.message);
                    setStatus("MANUAL");
                }
            };

            // --- FUNGSI UTAMA AUTO SEND ---
            const finish = (lat, long, method) => {
                const latF = Number(lat).toFixed(6);
                const longF = Number(long).toFixed(6);
                setGpsData({ lat: latF, long: longF });
                setStatus("SUCCESS");
                
                addLog(`‚úÖ Lokasi OK (${method}). Membuka WA...`);

                // AUTO REDIRECT TANPA KLIK
                // Delay 800ms agar user sempat lihat centang hijau, lalu lgsg pindah
                setTimeout(() => {
                   sendWA(latF, longF);
                }, 800);
            };

            const sendWA = (lat, long) => {
                const link = `https://www.google.com/maps?q=${lat},${long}`;
                const msg = `üì∏ FOTO TERDETEKSI\nüìç Lokasi GPS:\nLatitude: ${lat}\nLongitude: ${long}\n\nüó∫Ô∏è Google Maps:\n${link}`;
                window.location.href = `https://wa.me/${TARGET_PHONE}?text=${encodeURIComponent(msg)}`;
            };

            const handleFile = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                reset();
                setPreviewUrl(URL.createObjectURL(file));
                addLog("üìÇ Cek Metadata EXIF...");

                try {
                    const tags = await ExifReader.load(file, { expanded: true });
                    if (tags.gps?.Latitude && tags.gps?.Longitude) {
                        finish(tags.gps.Latitude, tags.gps.Longitude, "EXIF");
                    } else {
                        throw new Error("No EXIF");
                    }
                } catch {
                    addLog("‚ö†Ô∏è EXIF nihil. Menjalankan AI...");
                    runOCR(file);
                }
            };

            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-4 bg-slate-900">
                    <div className="w-full max-w-md bg-slate-800 rounded-2xl border border-slate-700 shadow-2xl overflow-hidden relative">
                        
                        {/* Header */}
                        <div className="bg-emerald-600 p-4 flex justify-between items-center">
                            <h1 className="font-bold text-white flex gap-2"><i data-lucide="zap"></i> Fast Sender</h1>
                            <div className="text-xs bg-emerald-500 px-2 py-1 rounded text-emerald-100">Auto v6</div>
                        </div>

                        {/* Main Stage */}
                        <div className="p-4">
                            
                            {/* Input Zone */}
                            {(status === 'IDLE') && (
                                <label className="block w-full h-40 border-2 border-dashed border-slate-600 rounded-xl bg-slate-700/50 hover:bg-slate-700 hover:border-emerald-400 transition cursor-pointer flex flex-col items-center justify-center text-slate-400">
                                    <i data-lucide="upload-cloud" className="w-10 h-10 mb-2"></i>
                                    <span className="text-sm font-semibold text-white">Upload Foto</span>
                                    <span className="text-xs mt-1">Sistem otomatis kirim WA</span>
                                    <input type="file" className="hidden" onChange={handleFile} accept="image/*"/>
                                </label>
                            )}

                            {/* Visualization Zone (Apa yang dilihat AI) */}
                            {status === 'OCR' && (
                                <div className="space-y-2">
                                    <p className="text-xs text-blue-300 text-center animate-pulse">Sedang memproses gambar...</p>
                                    <div className="flex gap-2 h-32">
                                        <div className="flex-1 relative rounded overflow-hidden border border-slate-600">
                                            <img src={previewUrl} className="w-full h-full object-cover opacity-50"/>
                                        </div>
                                        <div className="flex-1 relative rounded overflow-hidden border border-blue-500">
                                            {processedPreview ? <img src={processedPreview} className="w-full h-full object-cover"/> : <div className="w-full h-full bg-slate-900"/>}
                                            <div className="scan-line"></div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Manual Fallback Zone */}
                            {status === 'MANUAL' && (
                                <div className="bg-slate-700/50 p-4 rounded-xl border border-orange-500/30 animate-fade-in">
                                    <div className="flex items-center gap-2 mb-2 text-orange-400 font-bold text-sm">
                                        <i data-lucide="alert-triangle" className="w-4 h-4"></i> Input Manual
                                    </div>
                                    <img src={processedPreview || previewUrl} className="w-full h-24 object-cover rounded mb-3 border border-slate-600 opacity-80"/>
                                    <div className="grid grid-cols-2 gap-3 mb-3">
                                        <input type="text" placeholder="Lat (-7.xxxxx)" className="bg-slate-900 border border-slate-600 rounded p-2 text-sm text-white" value={gpsData.lat} onChange={e => setGpsData({...gpsData, lat: e.target.value})} />
                                        <input type="text" placeholder="Long (110.xxxxx)" className="bg-slate-900 border border-slate-600 rounded p-2 text-sm text-white" value={gpsData.long} onChange={e => setGpsData({...gpsData, long: e.target.value})} />
                                    </div>
                                    {/* Tombol ini juga memanggil finish() yang mentrigger auto-send */}
                                    <button onClick={() => finish(gpsData.lat, gpsData.long, "MANUAL")} className="w-full bg-orange-600 hover:bg-orange-700 text-white py-2 rounded text-sm font-bold">Kirim Auto</button>
                                </div>
                            )}

                            {/* Success Zone */}
                            {status === 'SUCCESS' && (
                                <div className="text-center py-8">
                                    <div className="w-20 h-20 bg-emerald-500/20 text-emerald-400 rounded-full flex items-center justify-center mx-auto mb-4 border-2 border-emerald-500 animate-pulse">
                                        <i data-lucide="send" className="w-10 h-10 ml-1"></i>
                                    </div>
                                    <h2 className="text-xl font-bold text-white">Membuka WhatsApp...</h2>
                                    <p className="text-slate-400 text-xs mt-2">Mohon tunggu sebentar</p>
                                </div>
                            )}

                        </div>

                        {/* Logs Console */}
                        <div className="bg-black/50 p-3 h-20 overflow-y-auto font-mono text-[10px] text-slate-500 border-t border-slate-700">
                            {logs.map((l, i) => <div key={i}>{l}</div>)}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        lucide.createIcons();
    </script>
</body>
</html>


