<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoSender Turbo v8</title>
    
    <!-- React & Core -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Libraries (Loaded Async for Speed) -->
    <script src="https://cdn.jsdelivr.net/npm/exifreader@4.20.0/dist/exif-reader.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { background-color: #020617; color: white; font-family: system-ui, -apple-system, sans-serif; }
        .turbo-gradient { background: linear-gradient(135deg, #f59e0b, #ef4444); } /* Warna Amber-Red untuk kesan Cepat */
        .glass { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .animate-pop { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        /* Hilangkan spinner default input number */
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">
    <div id="root" class="w-full max-w-md"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const TARGET_PHONE = "6287745756269"; 

        // --- HELPER: Fast Image Resizer for OCR (Bukan untuk dikirim, cuma untuk dibaca AI) ---
        const resizeForAI = (file) => {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    // Kecilkan ke max 800px (Cukup untuk baca teks, sangat cepat diproses)
                    const maxDim = 800; 
                    const scale = Math.min(maxDim / img.width, maxDim / img.height);
                    const w = img.width * (scale < 1 ? scale : 1);
                    const h = img.height * (scale < 1 ? scale : 1);
                    
                    canvas.width = w; canvas.height = h;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, w, h);
                    
                    // Filter Kontras Sederhana
                    const idata = ctx.getImageData(0,0,w,h);
                    const d = idata.data;
                    for(let i=0; i<d.length; i+=4) {
                        // Grayscale + High Contrast Threshold
                        const v = (0.2126*d[i] + 0.7152*d[i+1] + 0.0722*d[i+2]) > 120 ? 255 : 0;
                        d[i] = d[i+1] = d[i+2] = v;
                    }
                    ctx.putImageData(idata, 0, 0);
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                };
                img.src = URL.createObjectURL(file);
            });
        };

        const App = () => {
            const [status, setStatus] = useState('IDLE'); // IDLE, SCANNING, SUCCESS
            const [coords, setCoords] = useState({ lat: '', long: '' });
            const [address, setAddress] = useState('');
            const [rawFile, setRawFile] = useState(null);
            const [preview, setPreview] = useState(null);
            const [method, setMethod] = useState('');
            const fileRef = useRef(null);

            // --- ENGINE UTAMA ---
            const processFile = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                // 1. Setup UI Instant
                setRawFile(file); // Simpan file asli untuk share nanti (Tanpa konversi = Cepat)
                setPreview(URL.createObjectURL(file));
                setStatus('SCANNING');
                setAddress('Sedang mencari nama jalan...'); // Placeholder

                try {
                    // 2. Cek EXIF (Tercepat < 0.1s)
                    const tags = await ExifReader.load(file, { expanded: true });
                    if (tags.gps?.Latitude && tags.gps?.Longitude) {
                        finish(tags.gps.Latitude, tags.gps.Longitude, "EXIF Kilat");
                        return;
                    }
                    throw new Error("EXIF Missing");
                } catch {
                    // 3. Fallback ke OCR (Turbo Mode)
                    try {
                        const optimizedImg = await resizeForAI(file);
                        const worker = await Tesseract.createWorker('eng');
                        await worker.setParameters({ tessedit_char_whitelist: '0123456789.-,LatLong: ' });
                        const res = await worker.recognize(optimizedImg);
                        await worker.terminate();

                        const txt = res.data.text.replace(/[^0-9.,\-\n]/g, ' ');
                        const nums = txt.match(/-?\d{1,3}[.,]\d{4,}/g);

                        if (nums && nums.length >= 2) {
                            let v1 = parseFloat(nums[0].replace(',', '.'));
                            let v2 = parseFloat(nums[1].replace(',', '.'));
                            // Logic Lat/Long Indonesia
                            let lat = Math.abs(v1) > 90 ? v2 : v1;
                            let long = Math.abs(v1) > 90 ? v1 : v2;
                            finish(lat, long, "AI OCR");
                        } else {
                            // Gagal total -> Manual
                            setCoords({ lat: '', long: '' });
                            setAddress('Gagal deteksi. Masukkan manual.');
                            setStatus('SUCCESS'); // Masuk ke screen success tapi kosong agar bisa edit
                            setMethod("Manual Input");
                        }
                    } catch (err) {
                        setCoords({ lat: '', long: '' });
                        setStatus('SUCCESS');
                        setMethod("Error / Manual");
                    }
                }
            };

            const finish = (lat, long, source) => {
                const latFixed = Number(lat).toFixed(6);
                const longFixed = Number(long).toFixed(6);
                
                // 4. Update UI duluan (Jangan tunggu alamat!)
                setCoords({ lat: latFixed, long: longFixed });
                setMethod(source);
                setStatus('SUCCESS');

                // 5. Cari alamat di background (Async)
                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latFixed}&lon=${longFixed}&zoom=18&addressdetails=1`)
                    .then(r => r.json())
                    .then(d => setAddress(d.display_name || "Alamat tidak dikenal"))
                    .catch(() => setAddress("Gagal memuat alamat (Koneksi?)"));
            };

            // --- ACTION: SHARE ---
            const handleSend = async () => {
                const mapLink = `https://www.google.com/maps?q=${coords.lat},${coords.long}`;
                const caption = `üö® *LOKASI TERKINI*\n\nüìç *GPS:* ${coords.lat}, ${coords.long}\nüè† *Alamat:* ${address}\nüó∫Ô∏è *Maps:* ${mapLink}`;

                // Prioritas: Native Share (Paling Cepat & Ada Gambar)
                if (navigator.share && navigator.canShare && rawFile) {
                    try {
                        // Gunakan rawFile langsung! Zero processing time.
                        await navigator.share({
                            files: [rawFile],
                            title: 'Lokasi GPS',
                            text: caption
                        });
                        return;
                    } catch (e) {
                        console.log("Share batal/gagal, fallback ke WA Link");
                    }
                }

                // Fallback: WA Link (Hanya Teks & Link)
                window.location.href = `https://wa.me/${TARGET_PHONE}?text=${encodeURIComponent(caption)}`;
            };

            // --- UI ---
            return (
                <div className="w-full relative">
                    {/* Header */}
                    <div className="mb-6 flex items-center justify-between">
                        <h1 className="text-xl font-bold italic tracking-tighter bg-clip-text text-transparent bg-gradient-to-r from-orange-400 to-red-500">
                            GEOSENDER <span className="text-white not-italic text-sm font-mono border border-orange-500/50 rounded px-1 ml-1">TURBO</span>
                        </h1>
                        <div className="flex gap-2">
                             {status === 'SUCCESS' && (
                                <button onClick={() => {setStatus('IDLE'); setRawFile(null);}} className="text-xs bg-slate-800 px-3 py-1 rounded-full text-slate-400 hover:text-white transition">
                                    Reset
                                </button>
                             )}
                        </div>
                    </div>

                    {/* MAIN CARD */}
                    <div className="bg-slate-900 border border-slate-800 rounded-3xl overflow-hidden shadow-2xl shadow-orange-900/10 min-h-[400px] relative">
                        
                        {/* 1. STATE: IDLE (Upload) */}
                        {status === 'IDLE' && (
                            <div className="h-full flex flex-col animate-pop">
                                <label className="flex-1 flex flex-col items-center justify-center cursor-pointer group hover:bg-slate-800/50 transition duration-300 p-10 h-[400px]">
                                    <div className="w-20 h-20 rounded-full bg-gradient-to-tr from-slate-800 to-slate-700 flex items-center justify-center mb-6 group-hover:scale-110 transition shadow-[0_0_30px_rgba(249,115,22,0.1)] group-hover:shadow-[0_0_50px_rgba(249,115,22,0.3)]">
                                        <i data-lucide="zap" className="w-8 h-8 text-orange-500 fill-orange-500"></i>
                                    </div>
                                    <h2 className="text-xl font-bold text-white mb-2">Tap untuk Mulai</h2>
                                    <p className="text-slate-500 text-sm text-center">Auto-Scan Foto & Kirim Cepat</p>
                                    <input type="file" onChange={processFile} accept="image/*" className="hidden" ref={fileRef} />
                                </label>
                            </div>
                        )}

                        {/* 2. STATE: SCANNING (Loading) */}
                        {status === 'SCANNING' && (
                            <div className="h-[400px] flex flex-col items-center justify-center p-8 text-center space-y-6 animate-pop">
                                <div className="relative">
                                    <div className="w-16 h-16 border-4 border-slate-700 rounded-full"></div>
                                    <div className="absolute top-0 left-0 w-16 h-16 border-4 border-orange-500 rounded-full border-t-transparent animate-spin"></div>
                                </div>
                                <div>
                                    <h3 className="text-lg font-bold text-white animate-pulse">Memproses Cepat...</h3>
                                    <p className="text-xs text-slate-500 mt-1">Membaca EXIF & OCR Engine</p>
                                </div>
                            </div>
                        )}

                        {/* 3. STATE: SUCCESS (Result) */}
                        {status === 'SUCCESS' && (
                            <div className="flex flex-col h-full animate-pop">
                                {/* Image Header */}
                                <div className="h-48 relative bg-black">
                                    <img src={preview} className="w-full h-full object-cover opacity-80" />
                                    <div className="absolute inset-0 bg-gradient-to-t from-slate-900 via-transparent to-transparent"></div>
                                    <div className="absolute bottom-3 left-4 right-4 flex justify-between items-end">
                                        <div>
                                            <div className="text-[10px] font-bold text-orange-400 bg-orange-900/30 px-2 py-0.5 rounded border border-orange-500/30 inline-block mb-1">
                                                {method}
                                            </div>
                                            <div className="text-xs text-white/80 truncate max-w-[200px]">{address}</div>
                                        </div>
                                    </div>
                                </div>

                                {/* Controls */}
                                <div className="p-5 flex-1 flex flex-col gap-4 bg-slate-900">
                                    {/* Inputs (Editable) */}
                                    <div className="flex gap-3">
                                        <div className="flex-1">
                                            <label className="text-[10px] text-slate-500 uppercase font-bold ml-1">Latitude</label>
                                            <input type="number" value={coords.lat} onChange={e=>setCoords({...coords, lat:e.target.value})} 
                                                className="w-full bg-slate-800 border border-slate-700 rounded-xl px-3 py-2 text-sm font-mono focus:border-orange-500 outline-none transition" />
                                        </div>
                                        <div className="flex-1">
                                            <label className="text-[10px] text-slate-500 uppercase font-bold ml-1">Longitude</label>
                                            <input type="number" value={coords.long} onChange={e=>setCoords({...coords, long:e.target.value})} 
                                                className="w-full bg-slate-800 border border-slate-700 rounded-xl px-3 py-2 text-sm font-mono focus:border-orange-500 outline-none transition" />
                                        </div>
                                    </div>

                                    {/* Big Button */}
                                    <button onClick={handleSend} className="mt-auto w-full turbo-gradient text-white py-4 rounded-xl font-bold shadow-lg shadow-orange-900/40 active:scale-[0.98] transition-transform flex items-center justify-center gap-2 group">
                                        <span>KIRIM SEKARANG</span>
                                        <i data-lucide="send" className="w-5 h-5 group-hover:translate-x-1 transition-transform"></i>
                                    </button>
                                    <p className="text-[10px] text-center text-slate-600">
                                        Tekan tombol di atas, lalu pilih WhatsApp
                                    </p>
                                </div>
                            </div>
                        )}
                    </div>
                    
                    <div className="mt-6 text-center">
                         <p className="text-[10px] text-slate-600">GeoSender Turbo v8 ‚Ä¢ High Performance Engine</p>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        setTimeout(() => lucide.createIcons(), 500);
    </script>
</body>
</html>


