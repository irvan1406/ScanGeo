<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoSender High Precision</title>
    
    <!-- React & Libs -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/exifreader@4.20.0/dist/exif-reader.min.js"></script>
    
    <!-- Tesseract v5 -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0f172a; color: white; }
        .scan-line {
            position: absolute;
            width: 100%;
            height: 4px;
            background: #3b82f6;
            box-shadow: 0 0 10px #3b82f6;
            animation: scanning 2s linear infinite;
        }
        @keyframes scanning { 0% { top: 0; } 100% { top: 100%; } }
        /* Hide scrollbar for logs */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const TARGET_PHONE = "6287745756269";

        // --- IMAGE PROCESSING ENGINE ---
        // Fungsi ini mengubah foto jadi Hitam Putih (Binarization) agar teks jelas terbaca
        const preprocessImage = (imageFile) => {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Resize jika terlalu besar (max width 1024px) untuk performa
                    const maxWidth = 1500;
                    const scale = maxWidth / img.width;
                    canvas.width = img.width > maxWidth ? maxWidth : img.width;
                    canvas.height = img.width > maxWidth ? img.height * scale : img.height;
                    
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // Ambil data piksel
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    
                    // Loop piksel: Ubah ke Grayscale & Tingkatkan Kontras
                    for (let i = 0; i < data.length; i += 4) {
                        const r = data[i];
                        const g = data[i + 1];
                        const b = data[i + 2];
                        
                        // Rumus luminance (kecerahan)
                        let gray = 0.2126 * r + 0.7152 * g + 0.0722 * b;
                        
                        // Thresholding (Binarization): Jika terang jadi putih mutlak, gelap jadi hitam mutlak
                        // Angka 100 bisa diatur (0-255). 120 biasanya pas untuk teks putih di latar gelap.
                        const val = gray > 130 ? 255 : 0; 

                        data[i] = val;     // R
                        data[i + 1] = val; // G
                        data[i + 2] = val; // B
                    }
                    
                    ctx.putImageData(imageData, 0, 0);
                    
                    // Kembalikan sebagai Data URL (gambar baru)
                    resolve(canvas.toDataURL('image/jpeg'));
                };
                img.onerror = reject;
                img.src = URL.createObjectURL(imageFile);
            });
        };

        const App = () => {
            const [status, setStatus] = useState("IDLE"); // IDLE, PROCESSING, OCR, MANUAL, SUCCESS
            const [logs, setLogs] = useState([]);
            const [gpsData, setGpsData] = useState({ lat: '', long: '' });
            const [previewUrl, setPreviewUrl] = useState(null);
            const [processedPreview, setProcessedPreview] = useState(null);
            const [progress, setProgress] = useState(0);
            
            const fileInputRef = useRef(null);
            const addLog = (msg) => setLogs(p => [`> ${msg}`, ...p]);

            const reset = () => {
                setStatus("IDLE");
                setLogs([]);
                setGpsData({ lat: '', long: '' });
                setPreviewUrl(null);
                setProcessedPreview(null);
                setProgress(0);
                if(fileInputRef.current) fileInputRef.current.value = "";
            };

            const parseText = (text) => {
                // Regex agresif mencari pola angka desimal
                // Mencari angka seperti: -7.1234 atau 110.1234
                // Menangani spasi aneh hasil OCR: - 7 . 1234
                const cleanText = text.replace(/[^0-9.,\-\n]/g, ' '); // Hapus huruf, sisakan angka & simbol
                const numbers = cleanText.match(/-?\d{1,3}[.,]\d{4,}/g);

                if (numbers && numbers.length >= 2) {
                    // Asumsi: Angka pertama Lat, kedua Long (atau sebaliknya tergantung besaran)
                    // Biasanya Lat Indonesia -10 s/d 6, Long 95 s/d 141
                    let v1 = parseFloat(numbers[0].replace(',', '.'));
                    let v2 = parseFloat(numbers[1].replace(',', '.'));
                    
                    let lat = v1;
                    let long = v2;

                    // Swap logic pintar untuk Indonesia
                    // Jika v1 > 90, itu pasti Longitude
                    if (Math.abs(v1) > 90) { lat = v2; long = v1; }

                    if (lat >= -90 && lat <= 90 && long >= -180 && long <= 180) {
                        return { lat, long };
                    }
                }
                return null;
            };

            const runOCR = async (file) => {
                setStatus("OCR");
                addLog("‚öôÔ∏è Pre-processing: Mempertajam kontras...");
                
                try {
                    // 1. Proses Gambar (Jadi Hitam Putih)
                    const highContrastImage = await preprocessImage(file);
                    setProcessedPreview(highContrastImage); // Tampilkan apa yang dilihat AI
                    
                    addLog("üß† AI Membaca teks...");
                    
                    // 2. Jalankan Tesseract pada gambar hasil proses
                    const worker = await Tesseract.createWorker('eng');
                    // Whitelist: Paksa hanya baca angka dan simbol relevan
                    await worker.setParameters({
                        tessedit_char_whitelist: '0123456789.-,LatLong: ',
                    });

                    const ret = await worker.recognize(highContrastImage);
                    addLog("‚úÖ Scan selesai. Menganalisis hasil...");
                    
                    const coords = parseText(ret.data.text);
                    await worker.terminate();

                    if (coords) {
                        finish(coords.lat, coords.long, "AI Scan");
                    } else {
                        addLog("‚ö†Ô∏è Angka tidak ditemukan di hasil scan.");
                        setStatus("MANUAL");
                    }

                } catch (e) {
                    console.error(e);
                    addLog("‚ùå OCR Error: " + e.message);
                    setStatus("MANUAL");
                }
            };

            const finish = (lat, long, method) => {
                const latF = Number(lat).toFixed(6);
                const longF = Number(long).toFixed(6);
                setGpsData({ lat: latF, long: longF });
                setStatus("SUCCESS");
                
                setTimeout(() => {
                   sendWA(latF, longF);
                }, 1500);
            };

            const sendWA = (lat, long) => {
                const link = `https://www.google.com/maps?q=${lat},${long}`;
                const msg = `üì∏ FOTO TERDETEKSI\nüìç Lokasi GPS:\nLatitude: ${lat}\nLongitude: ${long}\n\nüó∫Ô∏è Google Maps:\n${link}`;
                window.location.href = `https://wa.me/${TARGET_PHONE}?text=${encodeURIComponent(msg)}`;
            };

            const handleFile = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                reset();
                setPreviewUrl(URL.createObjectURL(file));
                addLog("üìÇ File dimuat. Cek EXIF...");

                try {
                    const tags = await ExifReader.load(file, { expanded: true });
                    if (tags.gps?.Latitude && tags.gps?.Longitude) {
                        finish(tags.gps.Latitude, tags.gps.Longitude, "EXIF");
                    } else {
                        throw new Error("No EXIF");
                    }
                } catch {
                    addLog("‚ö†Ô∏è EXIF nihil. Menjalankan AI...");
                    runOCR(file);
                }
            };

            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-4 bg-slate-900">
                    <div className="w-full max-w-md bg-slate-800 rounded-2xl border border-slate-700 shadow-2xl overflow-hidden relative">
                        
                        {/* Header */}
                        <div className="bg-blue-600 p-4 flex justify-between items-center">
                            <h1 className="font-bold text-white flex gap-2"><i data-lucide="scan-eye"></i> Precision Scanner</h1>
                            <div className="text-xs bg-blue-500 px-2 py-1 rounded text-blue-100">v5.0</div>
                        </div>

                        {/* Main Stage */}
                        <div className="p-4">
                            
                            {/* Input Zone */}
                            {(status === 'IDLE' || status === 'SUCCESS') && (
                                <label className="block w-full h-40 border-2 border-dashed border-slate-600 rounded-xl bg-slate-700/50 hover:bg-slate-700 hover:border-blue-400 transition cursor-pointer flex flex-col items-center justify-center text-slate-400">
                                    <i data-lucide="upload-cloud" className="w-10 h-10 mb-2"></i>
                                    <span className="text-sm">Upload Foto (Watermark/EXIF)</span>
                                    <input type="file" className="hidden" onChange={handleFile} accept="image/*"/>
                                </label>
                            )}

                            {/* Visualization Zone (Apa yang dilihat AI) */}
                            {status === 'OCR' && (
                                <div className="space-y-2">
                                    <p className="text-xs text-blue-300 text-center animate-pulse">Sedang memproses kontras gambar...</p>
                                    <div className="flex gap-2 h-32">
                                        {/* Original */}
                                        <div className="flex-1 relative rounded overflow-hidden border border-slate-600">
                                            <img src={previewUrl} className="w-full h-full object-cover opacity-50"/>
                                            <div className="absolute inset-0 flex items-center justify-center text-xs font-bold text-white drop-shadow-md">ASLI</div>
                                        </div>
                                        {/* Processed */}
                                        <div className="flex-1 relative rounded overflow-hidden border border-blue-500">
                                            {processedPreview ? (
                                                <img src={processedPreview} className="w-full h-full object-cover"/>
                                            ) : (
                                                <div className="w-full h-full bg-slate-900 flex items-center justify-center"><div className="w-4 h-4 bg-blue-500 animate-spin rounded-sm"></div></div>
                                            )}
                                            <div className="scan-line"></div>
                                            <div className="absolute top-0 left-0 bg-blue-600 text-[10px] px-1 text-white">AI VISION</div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Manual Fallback Zone */}
                            {status === 'MANUAL' && (
                                <div className="bg-slate-700/50 p-4 rounded-xl border border-orange-500/30 animate-fade-in">
                                    <div className="flex items-start gap-3 mb-4">
                                        <img src={processedPreview || previewUrl} className="w-20 h-20 object-cover rounded border border-slate-500"/>
                                        <div className="flex-1">
                                            <h3 className="text-sm font-bold text-orange-400">Bantu konfirmasi</h3>
                                            <p className="text-xs text-slate-300 mt-1">AI kesulitan membaca digit yang tepat. Ketik manual:</p>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3 mb-3">
                                        <div>
                                            <label className="text-[10px] text-slate-400">Latitude</label>
                                            <input type="text" placeholder="-7.xxxxx" className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm focus:border-blue-500 outline-none text-white"
                                                value={gpsData.lat} onChange={e => setGpsData({...gpsData, lat: e.target.value})} />
                                        </div>
                                        <div>
                                            <label className="text-[10px] text-slate-400">Longitude</label>
                                            <input type="text" placeholder="110.xxxxx" className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm focus:border-blue-500 outline-none text-white"
                                                value={gpsData.long} onChange={e => setGpsData({...gpsData, long: e.target.value})} />
                                        </div>
                                    </div>
                                    <button onClick={() => finish(gpsData.lat, gpsData.long, "MANUAL")} className="w-full bg-orange-600 hover:bg-orange-700 text-white py-2 rounded text-sm font-bold">Kirim Sekarang</button>
                                </div>
                            )}

                            {/* Success Zone */}
                            {status === 'SUCCESS' && (
                                <div className="text-center py-4">
                                    <div className="w-16 h-16 bg-green-500/20 text-green-400 rounded-full flex items-center justify-center mx-auto mb-3 border border-green-500/50">
                                        <i data-lucide="check" className="w-8 h-8"></i>
                                    </div>
                                    <h2 className="text-xl font-bold text-white">Lokasi Terkunci</h2>
                                    <p className="text-slate-400 text-sm mb-4">Membuka WhatsApp...</p>
                                    <button onClick={() => sendWA(gpsData.lat, gpsData.long)} className="px-6 py-2 bg-green-600 rounded-full text-white text-sm font-bold shadow-lg shadow-green-900/20">Buka Manual</button>
                                </div>
                            )}

                        </div>

                        {/* Logs Console */}
                        <div className="bg-black/50 p-3 h-24 overflow-y-auto font-mono text-[10px] text-slate-500 border-t border-slate-700">
                            {logs.map((l, i) => <div key={i}>{l}</div>)}
                            {logs.length === 0 && <div>Menunggu file...</div>}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        lucide.createIcons();
    </script>
</body>
</html>


